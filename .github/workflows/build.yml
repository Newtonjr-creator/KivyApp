name: Build APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout Repository
      uses: actions/checkout@v3

    # Set up Java environment
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '11'

    # Install dependencies
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip python3 python3-pip

    # Download Android SDK Command Line Tools
    - name: Download Android SDK Command Line Tools
      run: |
        mkdir -p /home/runner/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O commandlinetools.zip
        unzip -o commandlinetools.zip -d /home/runner/android-sdk/cmdline-tools
        rm commandlinetools.zip

    # Ensure the sdkmanager path is in place
    - name: Ensure SDK Manager Path is Correct
      run: |
        mkdir -p /home/runner/android-sdk/cmdline-tools/latest
        mv /home/runner/android-sdk/cmdline-tools/cmdline-tools/* /home/runner/android-sdk/cmdline-tools/latest

        # Create necessary symlinks to make sdkmanager accessible
        SDKMANAGER_PATH="/home/runner/.buildozer/android/platform/android-sdk/tools/bin"
        mkdir -p $SDKMANAGER_PATH
        ln -sf /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager $SDKMANAGER_PATH/sdkmanager

    # Accept Android SDK Licenses
    - name: Accept SDK Licenses
      run: |
        yes | /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses

    # Install Build Tools, Platform Tools, and Extras
    - name: Install Android Build Tools and Dependencies
      run: |
        /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "build-tools;33.0.2" \
          "platforms;android-33" \
          "extras;android;m2repository" \
          "extras;google;m2repository"

    # Install AIDL if not found
    - name: Verify and Install AIDL
      run: |
        AIDL_PATH="/home/runner/android-sdk/build-tools/33.0.2/aidl"
        if [ ! -f "$AIDL_PATH" ]; then
          echo "AIDL is not installed. Attempting independent installation..."
          /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2"
          if [ -f "$AIDL_PATH" ]; then
            echo "AIDL successfully installed."
          else
            echo "AIDL installation failed. Exiting..."
            exit 1
          fi
        else
          echo "AIDL found at $AIDL_PATH"
        fi

    # Ensure Build Tools Path is correctly linked
    - name: Ensure Build Tools Path
      run: |
        mkdir -p /home/runner/.buildozer/android/platform/android-sdk
        ln -sf /home/runner/android-sdk/build-tools /home/runner/.buildozer/android/platform/android-sdk/

    # Install Python dependencies (e.g., buildozer and cython)
    - name: Install Python Dependencies
      run: |
        pip3 install --upgrade pip
        pip3 install buildozer Cython

    # Build APK with Buildozer (add specific environment variable to ensure SDK is used)
    - name: Build APK
      run: |
        export ANDROIDSDK=/home/runner/android-sdk
        export ANDROIDNDK=/home/runner/android-sdk/ndk-bundle
        cd $GITHUB_WORKSPACE
        buildozer android debug

    # Check if the APK was generated
    - name: Check if APK was generated
      run: |
        echo "Checking if APK exists..."
        ls -lh $GITHUB_WORKSPACE/bin/*.apk

    # Upload APK for download
    - name: Upload APK
      if: ${{ always() }}
      run: |
        if [ -f "$GITHUB_WORKSPACE/bin/*.apk" ]; then
          echo "APK found, uploading..."
          uses: actions/upload-artifact@v3
          with:
            name: FlappyBird-APK
            path: $GITHUB_WORKSPACE/bin/*.apk
        else
          echo "APK not found. Skipping upload."
        fi
