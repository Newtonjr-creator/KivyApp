name: Build APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout Repository
      uses: actions/checkout@v3

    # Set up Java environment
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '11'

    # Install dependencies
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip python3 python3-pip

    # Download Android Command Line Tools
    - name: Download Android SDK Command Line Tools
      run: |
        mkdir -p /home/runner/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O commandlinetools.zip
        unzip -o commandlinetools.zip -d /home/runner/android-sdk/cmdline-tools
        mkdir -p /home/runner/android-sdk/cmdline-tools/latest
        mv /home/runner/android-sdk/cmdline-tools/cmdline-tools/* /home/runner/android-sdk/cmdline-tools/latest

    # Accept Android SDK Licenses
    - name: Accept SDK Licenses
      run: |
        yes | /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses

    # Install Build Tools, Platform Tools, and Extras
    - name: Install Android Build Tools and Dependencies
      run: |
        /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" "build-tools;33.0.2" "platforms;android-33" "extras;android;m2repository" "extras;google;m2repository"

    # Install Python dependencies (e.g., buildozer and cython)
    - name: Install Python Dependencies
      run: |
        pip3 install --upgrade pip
        pip3 install buildozer Cython

    # Build APK
    - name: Build APK
      run: |
        cd $GITHUB_WORKSPACE
        buildozer android debug

    # Archive APK for download
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: FlappyBird-APK
        path: $GITHUB_WORKSPACE/bin/*.apk
